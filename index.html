<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ATOS QUIZ</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Fredoka+One&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<style>
:root {
  --bg: #080818;
  --surface: #111128;
  --surface2: #0e0e24;
  --surface3: #1a1a38;
  --accent: #f5a623;
  --accent2: #e8445a;
  --accent3: #26d0ce;
  --accent4: #a855f7;
  --text: #f0f0f8;
  --text-muted: #7070a0;
  --radius: 20px;
  --radius-sm: 12px;
  --glow-gold: rgba(245,166,35,0.4);
  --glow-teal: rgba(38,208,206,0.4);
  --glow-pink: rgba(232,68,90,0.4);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Nunito', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* â”€â”€ BACKGROUND ANIMATED â”€â”€ */
.bg-orbs {
  position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden;
}
.orb {
  position: absolute;
  border-radius: 50%;
  filter: blur(80px);
  opacity: 0.12;
  animation: orbFloat 12s ease-in-out infinite;
}
.orb1 { width: 600px; height: 600px; background: var(--accent); top: -200px; left: -200px; animation-delay: 0s; }
.orb2 { width: 500px; height: 500px; background: var(--accent3); bottom: -150px; right: -150px; animation-delay: -4s; }
.orb3 { width: 400px; height: 400px; background: var(--accent4); top: 40%; left: 50%; animation-delay: -8s; }
@keyframes orbFloat {
  0%,100% { transform: translate(0,0) scale(1); }
  33% { transform: translate(30px,-20px) scale(1.05); }
  66% { transform: translate(-20px,30px) scale(0.95); }
}

/* â”€â”€ PARTICLES â”€â”€ */
#particles { position: fixed; inset: 0; pointer-events: none; z-index: 0; }

#app {
  position: relative; z-index: 1;
  min-height: 100vh;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 20px;
}

.screen { display: none; width: 100%; max-width: 580px; }
.screen.active { display: flex; flex-direction: column; align-items: center; gap: 18px; animation: screenIn 0.4s cubic-bezier(0.34,1.2,0.64,1) forwards; }
@keyframes screenIn { from { opacity:0; transform: translateY(24px) scale(0.97); } to { opacity:1; transform:none; } }

/* â”€â”€ LOGO â”€â”€ */
.logo {
  font-family: 'Fredoka One', cursive;
  font-size: clamp(2.8rem, 9vw, 4.5rem);
  background: linear-gradient(135deg, #f5a623 0%, #e8445a 45%, #26d0ce 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  letter-spacing: 3px; text-align: center;
  filter: drop-shadow(0 0 30px rgba(245,166,35,0.5));
  animation: logoPulse 3s ease-in-out infinite;
}
@keyframes logoPulse {
  0%,100% { filter: drop-shadow(0 0 25px rgba(245,166,35,0.4)); }
  50% { filter: drop-shadow(0 0 50px rgba(245,166,35,0.7)); }
}

.subtitle {
  color: var(--text-muted); font-size: 0.85rem; font-weight: 700;
  letter-spacing: 4px; text-transform: uppercase; text-align: center;
}

/* â”€â”€ CARDS â”€â”€ */
.card {
  background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
  backdrop-filter: blur(20px);
  border-radius: var(--radius);
  padding: 28px; width: 100%;
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 20px 60px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.08);
  position: relative; overflow: hidden;
}
.card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
}

.card-title {
  font-family: 'Fredoka One', cursive; font-size: 1.3rem;
  color: var(--accent); margin-bottom: 18px;
  display: flex; align-items: center; gap: 8px;
}

/* â”€â”€ INPUTS â”€â”€ */
input, textarea {
  width: 100%;
  background: rgba(255,255,255,0.04);
  border: 2px solid rgba(255,255,255,0.08);
  border-radius: var(--radius-sm);
  color: var(--text); font-family: 'Nunito', sans-serif;
  font-size: 1rem; font-weight: 600;
  padding: 14px 18px; outline: none;
  transition: all 0.3s;
}
input:focus, textarea:focus {
  border-color: var(--accent);
  background: rgba(245,166,35,0.05);
  box-shadow: 0 0 0 4px rgba(245,166,35,0.1), 0 0 20px rgba(245,166,35,0.1);
}
input::placeholder, textarea::placeholder { color: var(--text-muted); font-weight: 400; }

/* â”€â”€ BUTTONS â”€â”€ */
.btn {
  border: none; border-radius: var(--radius-sm); cursor: pointer;
  font-family: 'Fredoka One', cursive; font-size: 1.1rem;
  letter-spacing: 1px; padding: 15px 28px;
  transition: all 0.25s; width: 100%;
  position: relative; overflow: hidden;
}
.btn::before {
  content: ''; position: absolute; top: 50%; left: 50%;
  width: 0; height: 0; border-radius: 50%;
  background: rgba(255,255,255,0.15);
  transform: translate(-50%,-50%);
  transition: width 0.5s, height 0.5s;
}
.btn:active::before { width: 300px; height: 300px; }
.btn:hover { transform: translateY(-2px); }
.btn:active { transform: translateY(0) scale(0.98); }

.btn-primary {
  background: linear-gradient(135deg, #f5a623, #e8900a);
  color: #1a1000;
  box-shadow: 0 6px 24px rgba(245,166,35,0.45), 0 2px 8px rgba(0,0,0,0.3);
}
.btn-primary:hover { box-shadow: 0 10px 32px rgba(245,166,35,0.6), 0 2px 8px rgba(0,0,0,0.3); }

.btn-secondary {
  background: linear-gradient(135deg, #26d0ce, #1ab8b6);
  color: #001a1a;
  box-shadow: 0 6px 24px rgba(38,208,206,0.4), 0 2px 8px rgba(0,0,0,0.3);
}
.btn-secondary:hover { box-shadow: 0 10px 32px rgba(38,208,206,0.55); }

.btn-danger {
  background: linear-gradient(135deg, #e8445a, #c73249);
  color: white;
  box-shadow: 0 6px 24px rgba(232,68,90,0.4);
}

.btn-ghost {
  background: rgba(255,255,255,0.05);
  color: var(--text-muted);
  border: 1.5px solid rgba(255,255,255,0.1);
}
.btn-ghost:hover { background: rgba(255,255,255,0.09); color: var(--text); }

.btn-purple {
  background: linear-gradient(135deg, #a855f7, #7c3aed);
  color: white;
  box-shadow: 0 6px 24px rgba(168,85,247,0.4);
}

.btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
.btn-sm { padding: 10px 18px; font-size: 0.9rem; width: auto; }

/* â”€â”€ HOME SCREEN â”€â”€ */
.home-features {
  display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;
}
.feat-item {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 12px; padding: 12px;
  display: flex; align-items: center; gap: 10px;
  font-size: 0.85rem; font-weight: 700; color: var(--text-muted);
}
.feat-icon { font-size: 1.4rem; }

/* â”€â”€ ROOM CODE â”€â”€ */
.room-code-box {
  background: rgba(245,166,35,0.06);
  border: 2px solid rgba(245,166,35,0.2);
  border-radius: 16px; padding: 16px 24px;
  text-align: center; margin-bottom: 12px;
}
.room-code {
  font-family: 'Fredoka One', cursive;
  font-size: clamp(2.2rem, 10vw, 3.5rem);
  letter-spacing: 10px; color: var(--accent);
  text-shadow: 0 0 30px rgba(245,166,35,0.5);
}
.room-code-label { color: var(--text-muted); font-size: 0.75rem; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 6px; }

/* â”€â”€ PLAYER LIST â”€â”€ */
.players-list { display: flex; flex-direction: column; gap: 8px; width: 100%; }
.player-item {
  display: flex; align-items: center; gap: 12px;
  background: rgba(255,255,255,0.03);
  border-radius: var(--radius-sm); padding: 11px 15px;
  border: 1px solid rgba(255,255,255,0.05);
  transition: all 0.2s; animation: slideIn 0.3s ease forwards;
}
@keyframes slideIn { from { opacity:0; transform:translateX(-12px); } to { opacity:1; transform:none; } }
.player-item:hover { background: rgba(255,255,255,0.05); }
.player-dot { width: 26px; height: 26px; border-radius: 50%; flex-shrink: 0; box-shadow: 0 0 12px currentColor; }
.player-name { font-weight: 700; font-size: 1rem; flex: 1; }
.player-ready { margin-left: auto; font-size: 0.8rem; }

/* â”€â”€ HOST BADGE â”€â”€ */
.host-badge {
  display: inline-block; background: rgba(245,166,35,0.15);
  color: var(--accent); border-radius: 50px; padding: 2px 10px;
  font-size: 0.7rem; font-weight: 800; margin-left: 6px;
  border: 1px solid rgba(245,166,35,0.3);
}

/* â”€â”€ COLORS GRID â”€â”€ */
.colors-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; width: 100%; }
.color-btn {
  aspect-ratio: 1; border-radius: 50%;
  border: 4px solid transparent; cursor: pointer;
  transition: all 0.25s; position: relative;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}
.color-btn:hover:not(.taken) { transform: scale(1.15); box-shadow: 0 8px 25px rgba(0,0,0,0.4); }
.color-btn.selected {
  border-color: white;
  box-shadow: 0 0 0 4px rgba(255,255,255,0.25), 0 8px 25px rgba(0,0,0,0.4);
  transform: scale(1.15);
}
.color-btn.taken { opacity: 0.2; cursor: not-allowed; }
.color-btn.taken::after {
  content: 'âœ•'; position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  color: white; font-size: 1.4rem; font-weight: 900;
}

/* â”€â”€ GOSTOS INPUTS â”€â”€ */
.gostos-list { display: flex; flex-direction: column; gap: 10px; width: 100%; }
.gosto-row { display: flex; align-items: center; gap: 10px; }
.gosto-num {
  width: 34px; height: 34px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-weight: 900; font-size: 0.9rem; flex-shrink: 0;
  color: var(--bg);
}

/* â”€â”€ GAME SCREEN â”€â”€ */
.game-header {
  width: 100%; display: flex; align-items: center;
  justify-content: space-between; gap: 10px;
}
.round-badge {
  display: inline-flex; align-items: center; gap: 6px;
  background: rgba(245,166,35,0.12);
  border: 1px solid rgba(245,166,35,0.3);
  color: var(--accent); padding: 7px 16px;
  border-radius: 50px; font-weight: 800;
  font-size: 0.82rem; letter-spacing: 2px; text-transform: uppercase;
}
.score-badge {
  display: inline-flex; align-items: center; gap: 5px;
  background: rgba(38,208,206,0.1);
  border: 1px solid rgba(38,208,206,0.25);
  color: var(--accent3); padding: 7px 14px;
  border-radius: 50px; font-weight: 800; font-size: 0.85rem;
}

/* â”€â”€ TIMER â”€â”€ */
.timer-wrap { width: 100%; position: relative; }
.timer-bar-bg {
  width: 100%; height: 10px;
  background: rgba(255,255,255,0.06);
  border-radius: 50px; overflow: hidden;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
}
.timer-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent3), var(--accent));
  border-radius: 50px;
  transition: width 0.2s linear;
  box-shadow: 0 0 12px rgba(245,166,35,0.5);
  position: relative;
}
.timer-bar-fill::after {
  content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 6px;
  background: white; border-radius: 50px; opacity: 0.6;
}
.timer-text {
  text-align: right; margin-top: 5px;
  font-size: 0.85rem; color: var(--text-muted); font-weight: 800;
}
.timer-urgent .timer-bar-fill { background: linear-gradient(90deg, #e8445a, #ff6b6b) !important; box-shadow: 0 0 15px rgba(232,68,90,0.8) !important; }
.timer-urgent .timer-text { color: var(--accent2); animation: pulse 0.5s ease infinite; }

/* â”€â”€ MYSTERY CARD (gosto display) â”€â”€ */
.mystery-card {
  width: 100%; border-radius: var(--radius);
  background: linear-gradient(145deg, rgba(168,85,247,0.08), rgba(38,208,206,0.08));
  border: 1px solid rgba(255,255,255,0.1);
  padding: 32px 24px; text-align: center;
  position: relative; overflow: hidden;
}
.mystery-card::before {
  content: ''; position: absolute; inset: -2px;
  background: linear-gradient(135deg, var(--accent), var(--accent4), var(--accent3));
  border-radius: inherit; z-index: -1; opacity: 0.3;
}
.mystery-question-mark {
  font-size: 3rem; margin-bottom: 10px;
  animation: bounce 2s ease-in-out infinite;
}
@keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
.mystery-label {
  font-size: 0.75rem; font-weight: 800; letter-spacing: 3px;
  text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px;
}
.gosto-text {
  font-size: clamp(1.3rem, 4vw, 1.8rem); font-weight: 800; line-height: 1.4;
  color: var(--text); text-shadow: 0 2px 20px rgba(255,255,255,0.1);
}

/* â”€â”€ VOTE GRID â”€â”€ */
.vote-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
.vote-btn {
  background: rgba(255,255,255,0.04);
  border: 2px solid rgba(255,255,255,0.08);
  border-radius: var(--radius-sm); padding: 14px 12px;
  cursor: pointer; transition: all 0.2s;
  display: flex; align-items: center; gap: 10px;
  font-family: 'Nunito', sans-serif; font-size: 0.95rem;
  font-weight: 700; color: var(--text);
  position: relative; overflow: hidden;
}
.vote-btn:hover:not(.disabled-vote) {
  border-color: var(--accent);
  background: rgba(245,166,35,0.08);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(245,166,35,0.2);
}
.vote-btn.voted {
  border-color: var(--accent3);
  background: rgba(38,208,206,0.12);
  box-shadow: 0 0 20px rgba(38,208,206,0.3);
}
.vote-btn.disabled-vote { opacity: 0.35; cursor: not-allowed; }
.vote-color {
  width: 30px; height: 30px; border-radius: 50%; flex-shrink: 0;
  border: 2px solid rgba(255,255,255,0.2);
  box-shadow: 0 0 12px currentColor;
}
.voted-badge {
  display: none; text-align: center; margin-top: 14px;
  background: rgba(38,208,206,0.1); border: 1px solid rgba(38,208,206,0.3);
  border-radius: 50px; padding: 10px 20px;
  color: var(--accent3); font-weight: 800; font-size: 0.95rem;
  animation: fadeIn 0.3s ease forwards;
}

/* â”€â”€ RESULT BARS â”€â”€ */
.result-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
.result-bar-bg {
  flex: 1; height: 38px;
  background: rgba(255,255,255,0.04);
  border-radius: 10px; overflow: hidden; position: relative;
  border: 1px solid rgba(255,255,255,0.06);
}
.result-bar-fill {
  height: 100%; border-radius: 10px;
  transition: width 1.2s cubic-bezier(0.4,0,0.2,1);
  display: flex; align-items: center;
  padding-left: 12px; font-weight: 800; font-size: 0.88rem;
  color: rgba(0,0,0,0.8);
}
.result-pct {
  position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
  font-weight: 800; font-size: 0.85rem; color: var(--text);
}
.owner-crown { font-size: 1.1rem; }

/* â”€â”€ REVEAL BANNER â”€â”€ */
.reveal-banner {
  background: linear-gradient(135deg, rgba(245,166,35,0.1), rgba(232,68,90,0.1));
  border: 1px solid rgba(245,166,35,0.2);
  border-radius: 14px; padding: 14px 18px;
  text-align: center; margin-bottom: 16px;
}
.reveal-label { font-size: 0.72rem; font-weight: 800; letter-spacing: 3px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; }
.reveal-name { font-family: 'Fredoka One', cursive; font-size: 1.5rem; color: var(--accent); }
.reveal-dot { width: 32px; height: 32px; border-radius: 50%; display: inline-block; vertical-align: middle; margin-right: 10px; border: 2px solid rgba(255,255,255,0.3); box-shadow: 0 0 15px currentColor; }

/* â”€â”€ SCORE / COMBO â”€â”€ */
.combo-banner {
  display: none; text-align: center;
  background: linear-gradient(135deg, rgba(168,85,247,0.15), rgba(245,166,35,0.15));
  border: 1px solid rgba(168,85,247,0.3);
  border-radius: 14px; padding: 14px;
  margin-top: 10px;
}
.combo-text { font-family: 'Fredoka One', cursive; font-size: 1.8rem; color: var(--accent4); }
.combo-sub { color: var(--text-muted); font-size: 0.85rem; font-weight: 700; }

/* â”€â”€ PROGRESS BAR â”€â”€ */
.progress-wrap { width: 100%; }
.progress-label { display: flex; justify-content: space-between; font-size: 0.78rem; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; }
.progress-bg { width: 100%; height: 6px; background: rgba(255,255,255,0.06); border-radius: 50px; overflow: hidden; }
.progress-fill {
  height: 100%; border-radius: 50px;
  background: linear-gradient(90deg, var(--accent4), var(--accent));
  transition: width 0.8s ease;
}

/* â”€â”€ FINAL SCREEN â”€â”€ */
.winner-banner { text-align: center; padding: 24px 20px; }
.winner-crown { font-size: 4rem; animation: bounce 1s ease infinite; display: block; margin-bottom: 6px; }
.winner-label { color: var(--text-muted); font-size: 0.75rem; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 6px; font-weight: 700; }
.winner-name { font-family: 'Fredoka One', cursive; font-size: 2.2rem; color: var(--accent); margin-bottom: 4px; text-shadow: 0 0 30px var(--glow-gold); }
.winner-pts { color: var(--accent3); font-weight: 800; font-size: 1.2rem; }

.score-row {
  display: flex; align-items: center; gap: 12px;
  background: rgba(255,255,255,0.03);
  border-radius: var(--radius-sm); padding: 13px 16px;
  margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.05);
  transition: all 0.2s;
}
.score-row:hover { background: rgba(255,255,255,0.06); }
.score-pos { font-family: 'Fredoka One', cursive; font-size: 1.5rem; width: 32px; text-align: center; }
.score-pts { margin-left: auto; font-family: 'Fredoka One', cursive; font-size: 1.2rem; color: var(--accent3); }

/* â”€â”€ FINAL TABLES â”€â”€ */
.table-wrap {
  background: rgba(255,255,255,0.02); border-radius: var(--radius);
  overflow: hidden; width: 100%;
  border: 1px solid rgba(255,255,255,0.06); margin-bottom: 14px;
}
.table-header {
  padding: 14px 18px; display: flex; align-items: center; gap: 12px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
  background: rgba(255,255,255,0.03);
}
.table-header-color { width: 32px; height: 32px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.2); }
.table-header-name { font-family: 'Fredoka One', cursive; font-size: 1.2rem; }
.final-table { width: 100%; border-collapse: collapse; font-size: 0.88rem; }
.final-table th { background: rgba(245,166,35,0.08); color: var(--accent); padding: 10px 14px; text-align: left; font-weight: 800; font-size: 0.78rem; letter-spacing: 1.5px; text-transform: uppercase; border-bottom: 1px solid rgba(245,166,35,0.15); }
.final-table td { padding: 10px 14px; border-bottom: 1px solid rgba(255,255,255,0.04); font-weight: 600; }
.final-table tr:last-child td { border-bottom: none; }
.final-table tr:hover td { background: rgba(255,255,255,0.02); }

/* â”€â”€ CHIPS â”€â”€ */
.chip { display: inline-block; padding: 4px 12px; border-radius: 50px; font-size: 0.78rem; font-weight: 700; }
.chip-green { background: rgba(38,208,206,0.12); color: var(--accent3); border: 1px solid rgba(38,208,206,0.2); }
.chip-red { background: rgba(232,68,90,0.12); color: var(--accent2); border: 1px solid rgba(232,68,90,0.2); }
.chip-gold { background: rgba(245,166,35,0.12); color: var(--accent); border: 1px solid rgba(245,166,35,0.2); }
.chip-purple { background: rgba(168,85,247,0.12); color: var(--accent4); border: 1px solid rgba(168,85,247,0.2); }

/* â”€â”€ TOAST â”€â”€ */
#toast {
  position: fixed; bottom: 28px; left: 50%;
  transform: translateX(-50%) translateY(120px);
  background: rgba(20,20,40,0.95);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 50px; padding: 12px 24px;
  font-weight: 700; font-size: 0.95rem; z-index: 9999;
  transition: transform 0.35s cubic-bezier(0.34,1.3,0.64,1);
  box-shadow: 0 10px 40px rgba(0,0,0,0.6);
  white-space: nowrap; max-width: 90vw;
}
#toast.show { transform: translateX(-50%) translateY(0); }

/* â”€â”€ CONFETTI â”€â”€ */
.confetti-piece {
  position: fixed; top: -10px; border-radius: 3px;
  animation: confettiFall linear forwards;
  pointer-events: none; z-index: 9998;
}
@keyframes confettiFall {
  to { transform: translateY(110vh) rotate(720deg); opacity: 0; }
}

/* â”€â”€ MISC â”€â”€ */
.divider { width:100%; height:1px; background:rgba(255,255,255,0.06); margin:8px 0; }
.text-center { text-align: center; }
.text-muted { color: var(--text-muted); font-size: 0.9rem; }
.flex-row { display: flex; gap: 10px; width: 100%; }
.flex-row .btn { flex: 1; }

@keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }
@keyframes pop { 0%{transform:scale(0.5);opacity:0} 70%{transform:scale(1.05)} 100%{transform:scale(1);opacity:1} }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
@keyframes shimmer { 0%{left:-100%} 100%{left:200%} }
.fade-in { animation: fadeIn 0.4s ease forwards; }
.pop-in { animation: pop 0.6s cubic-bezier(0.34,1.56,0.64,1) forwards; }
.pulsing { animation: pulse 1.5s ease infinite; }

/* â”€â”€ WAITING DOTS â”€â”€ */
.waiting-dots::after {
  content: ''; animation: dots 1.5s steps(4,end) infinite;
}
@keyframes dots { 0%{content:''} 25%{content:'.'} 50%{content:'..'} 75%{content:'...'} }

/* â”€â”€ COUNTDOWN CIRCLE â”€â”€ */
.countdown-wrap { position: relative; width: 60px; height: 60px; flex-shrink: 0; }
.countdown-svg { width: 60px; height: 60px; transform: rotate(-90deg); }
.countdown-track { fill: none; stroke: rgba(255,255,255,0.06); stroke-width: 5; }
.countdown-fill { fill: none; stroke: var(--accent3); stroke-width: 5; stroke-linecap: round; transition: stroke-dashoffset 0.2s linear; }
.countdown-num { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-family: 'Fredoka One', cursive; font-size: 1.2rem; color: var(--accent3); }

/* â”€â”€ LIVE INDICATOR â”€â”€ */
.live-dot { width: 8px; height: 8px; border-radius: 50%; background: #4cd964; display: inline-block; animation: livePulse 1.2s ease infinite; margin-right: 4px; }
@keyframes livePulse { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.5);opacity:0.6} }

/* â”€â”€ STATS BOX â”€â”€ */
.stat-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; width: 100%; }
.stat-box {
  background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
  border-radius: 12px; padding: 12px; text-align: center;
}
.stat-val { font-family: 'Fredoka One', cursive; font-size: 1.6rem; color: var(--accent); }
.stat-label { font-size: 0.72rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

@media (max-width: 480px) {
  .vote-grid { grid-template-columns: 1fr; }
  .colors-grid { grid-template-columns: repeat(4,1fr); }
  .card { padding: 18px; }
  .home-features { grid-template-columns: 1fr; }
  .stat-grid { grid-template-columns: repeat(3,1fr); }
}
</style>
</head>
<body>

<div class="bg-orbs">
  <div class="orb orb1"></div>
  <div class="orb orb2"></div>
  <div class="orb orb3"></div>
</div>
<canvas id="particles"></canvas>

<div id="app">

  <!-- â”€â”€ HOME â”€â”€ -->
  <div id="screen-home" class="screen active">
    <div class="logo pop-in">ATOS QUIZ</div>
    <div class="subtitle fade-in">âœ¦ Quem vocÃª conhece de verdade? âœ¦</div>

    <div class="card fade-in" style="margin-top:6px;">
      <div class="home-features">
        <div class="feat-item"><span class="feat-icon">ğŸ­</span>Identidade secreta</div>
        <div class="feat-item"><span class="feat-icon">âš¡</span>Tempo real</div>
        <div class="feat-item"><span class="feat-icon">ğŸ†</span>Ranking ao vivo</div>
        <div class="feat-item"><span class="feat-icon">ğŸ¯</span>AtÃ© 8 jogadores</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:12px;">
        <button class="btn btn-primary" onclick="showScreen('create-room')">âœ¨ Criar Sala</button>
        <button class="btn btn-secondary" onclick="showScreen('join-room')">ğŸ”‘ Entrar com CÃ³digo</button>
      </div>
    </div>
  </div>

  <!-- â”€â”€ CREATE ROOM â”€â”€ -->
  <div id="screen-create-room" class="screen">
    <div class="logo" style="font-size:2rem;">ATOS QUIZ</div>
    <div class="card fade-in">
      <div class="card-title">âœ¨ Criar Sala</div>
      <div style="display:flex;flex-direction:column;gap:14px;">
        <div>
          <label style="display:block;font-weight:700;margin-bottom:6px;font-size:0.82rem;color:var(--text-muted);letter-spacing:2px;text-transform:uppercase;">Seu Nome</label>
          <input id="create-name" type="text" placeholder="Como quer ser chamado?" maxlength="20">
        </div>
        <div>
          <label style="display:block;font-weight:700;margin-bottom:10px;font-size:0.82rem;color:var(--text-muted);letter-spacing:2px;text-transform:uppercase;">MÃ¡x. Jogadores (2â€“8)</label>
          <div style="display:flex;align-items:center;justify-content:center;gap:20px;">
            <button class="btn btn-ghost btn-sm" style="width:46px;height:46px;font-size:1.5rem;padding:0;border-radius:50%;" onclick="adjustMax(-1)">âˆ’</button>
            <span id="max-players-display" style="font-family:'Fredoka One',cursive;font-size:2.5rem;color:var(--accent);min-width:50px;text-align:center;">6</span>
            <button class="btn btn-ghost btn-sm" style="width:46px;height:46px;font-size:1.5rem;padding:0;border-radius:50%;" onclick="adjustMax(1)">+</button>
          </div>
        </div>
        <div class="flex-row" style="margin-top:6px;">
          <button class="btn btn-ghost" onclick="showScreen('home')">â† Voltar</button>
          <button class="btn btn-primary" onclick="createRoom()">Criar Sala ğŸš€</button>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ JOIN ROOM â”€â”€ -->
  <div id="screen-join-room" class="screen">
    <div class="logo" style="font-size:2rem;">ATOS QUIZ</div>
    <div class="card fade-in">
      <div class="card-title">ğŸ”‘ Entrar na Sala</div>
      <div style="display:flex;flex-direction:column;gap:14px;">
        <div>
          <label style="display:block;font-weight:700;margin-bottom:6px;font-size:0.82rem;color:var(--text-muted);letter-spacing:2px;text-transform:uppercase;">CÃ³digo da Sala</label>
          <input id="join-code" type="text" placeholder="ABC123" maxlength="6" style="text-transform:uppercase;letter-spacing:6px;font-size:1.5rem;text-align:center;font-family:'Fredoka One',cursive;">
        </div>
        <div>
          <label style="display:block;font-weight:700;margin-bottom:6px;font-size:0.82rem;color:var(--text-muted);letter-spacing:2px;text-transform:uppercase;">Seu Nome</label>
          <input id="join-name" type="text" placeholder="Como quer ser chamado?" maxlength="20">
        </div>
        <div class="flex-row" style="margin-top:6px;">
          <button class="btn btn-ghost" onclick="showScreen('home')">â† Voltar</button>
          <button class="btn btn-secondary" id="join-btn" onclick="joinRoom()">Entrar ğŸ®</button>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ LOBBY â”€â”€ -->
  <div id="screen-lobby" class="screen">
    <div class="logo" style="font-size:2rem;">ATOS QUIZ</div>

    <div class="card fade-in" style="text-align:center;">
      <div class="room-code-label">CÃ³digo da Sala</div>
      <div class="room-code-box">
        <div class="room-code" id="lobby-code">------</div>
      </div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button class="btn btn-ghost btn-sm" onclick="copyCode()">ğŸ“‹ Copiar</button>
        <button class="btn btn-ghost btn-sm" onclick="shareCode()">ğŸ“¤ Compartilhar</button>
      </div>
    </div>

    <div class="card fade-in">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
        <div style="font-weight:800;font-size:0.9rem;display:flex;align-items:center;gap:6px;">
          <span class="live-dot"></span>JOGADORES
          <span style="color:var(--accent);" id="lobby-count">0</span>/<span id="lobby-max">6</span>
        </div>
        <span class="text-muted pulsing" style="font-size:0.82rem;">Aguardando<span class="waiting-dots"></span></span>
      </div>
      <div class="players-list" id="lobby-players"></div>
    </div>

    <div id="lobby-start-wrap" style="width:100%;display:none;">
      <button class="btn btn-primary" onclick="startGame()">ğŸš€ Iniciar Jogo!</button>
    </div>
    <div id="lobby-wait-msg" class="text-muted text-center pulsing" style="font-size:0.9rem;">â³ Aguardando o host iniciar...</div>
  </div>

  <!-- â”€â”€ COLOR PICK â”€â”€ -->
  <div id="screen-color" class="screen">
    <div class="logo" style="font-size:2rem;">ATOS QUIZ</div>
    <div class="card fade-in">
      <div class="card-title">ğŸ¨ Escolha sua Cor</div>
      <p class="text-muted" style="margin-bottom:20px;line-height:1.6;">Essa serÃ¡ sua <strong style="color:var(--text);">identidade secreta</strong> no jogo. Os outros nÃ£o saberÃ£o quem Ã© vocÃª... atÃ© o final!</p>
      <div class="colors-grid" id="colors-grid"></div>
      <button class="btn btn-primary" style="margin-top:22px;" id="confirm-color-btn" onclick="confirmColor()" disabled>Confirmar Cor âœ“</button>
    </div>
  </div>

  <!-- â”€â”€ GOSTOS â”€â”€ -->
  <div id="screen-gostos" class="screen">
    <div class="logo" style="font-size:2rem;">ATOS QUIZ</div>

    <div class="card fade-in">
      <div class="card-title">ğŸ’¬ Seus 5 Gostos</div>
      <p class="text-muted" style="margin-bottom:18px;line-height:1.6;">Escreva 5 coisas que vocÃª gosta. <strong style="color:var(--accent);">Seja especÃ­fico!</strong> "Cachorro-quente Ã s 2h" Ã© melhor que "comida".</p>
      <div class="gostos-list" id="gostos-inputs"></div>
      <button class="btn btn-primary" style="margin-top:20px;" id="confirm-gostos-btn" onclick="confirmGostos()">âœ… Confirmar Gostos</button>
    </div>

    <div class="card fade-in">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <span style="font-weight:800;font-size:0.9rem;">PRONTOS</span>
        <span id="ready-count" style="color:var(--accent);font-weight:800;font-family:'Fredoka One',cursive;font-size:1.1rem;">0/1</span>
      </div>
      <div class="players-list" id="ready-players"></div>
    </div>
  </div>

  <!-- â”€â”€ GAME â”€â”€ -->
  <div id="screen-game" class="screen">

    <div class="game-header">
      <div class="round-badge" id="round-counter">GOSTO 1/?</div>
      <div style="display:flex;align-items:center;gap:8px;">
        <div class="countdown-wrap">
          <svg class="countdown-svg" viewBox="0 0 60 60">
            <circle class="countdown-track" cx="30" cy="30" r="26"/>
            <circle class="countdown-fill" id="countdown-circle" cx="30" cy="30" r="26"
              stroke-dasharray="163.4" stroke-dashoffset="0"/>
          </svg>
          <div class="countdown-num" id="timer-text">20</div>
        </div>
        <div class="score-badge">â­ <span id="my-score">0</span> pts</div>
      </div>
    </div>

    <div class="progress-wrap">
      <div class="progress-label">
        <span>Progresso</span>
        <span id="progress-label-text">0 / 0 gostos</span>
      </div>
      <div class="progress-bg"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
    </div>

    <div class="mystery-card fade-in">
      <div class="mystery-question-mark">ğŸ•µï¸</div>
      <div class="mystery-label">Gosto AnÃ´nimo â€” Quem escreveu?</div>
      <div class="gosto-text" id="gosto-text">?</div>
    </div>

    <div class="card" style="padding:16px;">
      <div class="card-title" style="font-size:0.95rem;margin-bottom:12px;">ğŸ—³ï¸ Quem escreveu este gosto?</div>
      <div class="vote-grid" id="vote-grid"></div>
      <div class="voted-badge" id="voted-msg">âœ… Voto registrado! Aguardando todos...</div>
    </div>

  </div>

  <!-- â”€â”€ VOTE RESULTS â”€â”€ -->
  <div id="screen-vote-results" class="screen">
    <div class="logo" style="font-size:2rem;">ATOS QUIZ</div>

    <div class="card fade-in">
      <div class="card-title">ğŸ“Š Resultado</div>

      <div class="mystery-card" style="margin-bottom:16px;">
        <div class="mystery-label">O Gosto Era:</div>
        <div class="gosto-text" id="result-gosto-text" style="margin-bottom:12px;"></div>
        <div class="reveal-banner" style="background:none;border:none;padding:6px 0 0;margin-bottom:0;">
          <div class="reveal-label">Escrito por</div>
          <div id="result-owner-row" style="display:flex;align-items:center;justify-content:center;gap:8px;margin-top:4px;">
            <div id="result-gosto-color" style="width:32px;height:32px;border-radius:50%;border:2px solid rgba(255,255,255,0.3);box-shadow:0 0 15px currentColor;"></div>
            <span id="result-owner-name" style="font-family:'Fredoka One',cursive;font-size:1.4rem;color:var(--accent);">?</span>
          </div>
        </div>
      </div>

      <div id="result-bars"></div>
      <div id="combo-banner" class="combo-banner">
        <div class="combo-text" id="combo-text">ğŸ”¥ +100</div>
        <div class="combo-sub" id="combo-sub">VocÃª acertou!</div>
      </div>
    </div>

    <div id="next-btn-wrap" style="width:100%;display:none;">
      <button class="btn btn-primary" onclick="nextRound()">PrÃ³ximo Gosto âœ</button>
    </div>
    <div id="next-wait-msg" class="text-muted text-center pulsing" style="font-size:0.9rem;">â³ Aguardando o host continuar...</div>
  </div>

  <!-- â”€â”€ FINAL â”€â”€ -->
  <div id="screen-final" class="screen">
    <div class="logo" style="font-size:2rem;">ATOS QUIZ</div>

    <div class="card fade-in">
      <div class="winner-banner">
        <span class="winner-crown">ğŸ‘‘</span>
        <div class="winner-label">Vencedor</div>
        <div class="winner-name" id="winner-name"></div>
        <div class="winner-pts" id="winner-pts"></div>
      </div>
    </div>

    <div class="card fade-in">
      <div class="card-title">ğŸ† Placar Final</div>
      <div id="final-stat-grid" class="stat-grid" style="margin-bottom:16px;"></div>
      <div id="final-scores"></div>
    </div>

    <div id="final-tables-wrap" style="width:100%;"></div>

    <button class="btn btn-primary" onclick="resetGame()" style="width:100%;">ğŸ”„ Jogar Novamente</button>
  </div>

</div>

<div id="toast"></div>

<script>
// =============================================
//  ATOS QUIZ v3 â€” Firebase + 50 melhorias
// =============================================

const firebaseConfig = {
  apiKey: "AIzaSyAvh5lk4V9t3PgolmLQyrkJR5b0ZUOCpH8",
  authDomain: "quiz-atos.firebaseapp.com",
  databaseURL: "https://quiz-atos-default-rtdb.firebaseio.com",
  projectId: "quiz-atos",
  storageBucket: "quiz-atos.firebasestorage.app",
  messagingSenderId: "193416458072",
  appId: "1:193416458072:web:e865a004c9459910eaff2d",
  measurementId: "G-FD9BR7GJ3E"
};

let db;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  console.log("âœ… Firebase conectado!");
} catch(e) { console.error("Firebase init error:", e); }

// â”€â”€ Firebase helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fbSet(path, val) {
  try { await db.ref(path).set(val); return true; }
  catch(e) { console.error('[fbSet]', path, e.message); return false; }
}
async function fbGet(path) {
  try { const s = await db.ref(path).get(); return s.exists() ? s.val() : null; }
  catch(e) { console.error('[fbGet]', path, e.message); return null; }
}
async function fbUpdate(path, val) {
  try { await db.ref(path).update(val); return true; }
  catch(e) { console.error('[fbUpdate]', path, e.message); return false; }
}
function fbListen(path, cb) {
  const r = db.ref(path);
  r.on('value', s => cb(s.exists() ? s.val() : null));
  return () => r.off('value');
}

// â”€â”€ Constantes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLORS = [
  { id:'red',    hex:'#e8445a', name:'Vermelho' },
  { id:'orange', hex:'#f5a623', name:'Laranja'  },
  { id:'yellow', hex:'#f7d154', name:'Amarelo'  },
  { id:'green',  hex:'#4cd964', name:'Verde'    },
  { id:'teal',   hex:'#26d0ce', name:'Turquesa' },
  { id:'blue',   hex:'#4a90e2', name:'Azul'     },
  { id:'purple', hex:'#9b59b6', name:'Roxo'     },
  { id:'pink',   hex:'#ff6ba8', name:'Rosa'     },
];
const VOTE_TIME = 20;
const CIRCUMFERENCE = 2 * Math.PI * 26; // r=26

let S = {
  myId:null, myName:null, myColor:null, myGostos:[],
  roomCode:null, isHost:false, maxPlayers:6,
  selectedColor:null, timerInterval:null,
  hasVoted:false, currentRoundIdx:-1,
  unsubRoom:null, combo:0, totalRounds:0,
};

// â”€â”€ Paths â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pRoom   = c       => `rooms/${c}`;
const pPlayer = (c,id)  => `rooms/${c}/players/${id}`;
const pColor  = (c,id)  => `rooms/${c}/colors/${id}`;
const pGostos = (c,id)  => `rooms/${c}/gostos/${id}`;
const pVote   = (c,r,id)=> `rooms/${c}/votes/${r}/${id}`;

// â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const genCode  = () => Math.random().toString(36).substring(2,8).toUpperCase();
const genId    = () => Date.now().toString(36) + Math.random().toString(36).substr(2,4);
const colorHex = id => COLORS.find(c=>c.id===id)?.hex || '#888';
const colorName= id => COLORS.find(c=>c.id===id)?.name || id;

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const el = document.getElementById('screen-'+id);
  if (el) el.classList.add('active');
  window.scrollTo({top:0, behavior:'smooth'});
}
window.showScreen = showScreen;

let _toastTimer;
function toast(msg, dur=2800) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(()=>t.classList.remove('show'), dur);
}

// â”€â”€ Particles background â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function initParticles() {
  const canvas = document.getElementById('particles');
  const ctx = canvas.getContext('2d');
  let particles = [];
  function resize() { canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
  resize(); window.addEventListener('resize', resize);
  for (let i=0; i<55; i++) {
    particles.push({
      x: Math.random()*window.innerWidth, y: Math.random()*window.innerHeight,
      r: Math.random()*1.5+0.3, vx:(Math.random()-0.5)*0.3, vy:(Math.random()-0.5)*0.3,
      a: Math.random()*0.4+0.05
    });
  }
  function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    particles.forEach(p => {
      p.x+=p.vx; p.y+=p.vy;
      if(p.x<0)p.x=canvas.width; if(p.x>canvas.width)p.x=0;
      if(p.y<0)p.y=canvas.height; if(p.y>canvas.height)p.y=0;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fillStyle=`rgba(255,255,255,${p.a})`; ctx.fill();
    });
    requestAnimationFrame(draw);
  }
  draw();
})();

// â”€â”€ Confetti â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function launchConfetti(count=80) {
  const colors = ['#f5a623','#e8445a','#26d0ce','#a855f7','#4cd964','#f7d154','#ff6ba8'];
  for (let i=0; i<count; i++) {
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    const size = Math.random()*10+6;
    el.style.cssText = `
      left:${Math.random()*100}vw; width:${size}px; height:${size*0.6}px;
      background:${colors[Math.floor(Math.random()*colors.length)]};
      transform:rotate(${Math.random()*360}deg);
      animation-duration:${Math.random()*2+2}s;
      animation-delay:${Math.random()*1.5}s;
      opacity:${Math.random()*0.8+0.2};
    `;
    document.body.appendChild(el);
    el.addEventListener('animationend', ()=>el.remove());
  }
}

// â”€â”€ Ripple sound feedback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playTone(freq=440, type='sine', dur=0.1, vol=0.08) {
  try {
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.frequency.value = freq; o.type = type;
    g.gain.setValueAtTime(vol, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+dur);
    o.start(ctx.currentTime); o.stop(ctx.currentTime+dur);
  } catch(e) {}
}
function playSuccess() { playTone(523,0.08); setTimeout(()=>playTone(659,0.08),80); setTimeout(()=>playTone(784,0.12),160); }
function playError()   { playTone(200,'sawtooth',0.15,0.06); }
function playVote()    { playTone(440,'sine',0.08); }
function playTick()    { playTone(800,'sine',0.05,0.04); }

// â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function adjustMax(d) {
  S.maxPlayers = Math.min(8, Math.max(2, S.maxPlayers+d));
  document.getElementById('max-players-display').textContent = S.maxPlayers;
  playTone(d>0?500:400);
}
window.adjustMax = adjustMax;

function copyCode() {
  navigator.clipboard.writeText(S.roomCode)
    .then(()=>{ toast('âœ… CÃ³digo copiado!'); playSuccess(); });
}
window.copyCode = copyCode;

function shareCode() {
  if (navigator.share) {
    navigator.share({ title:'ATOS QUIZ', text:`Entre na minha sala! CÃ³digo: ${S.roomCode}`, url: window.location.href })
      .catch(()=>{});
  } else { copyCode(); }
}
window.shareCode = shareCode;

// â”€â”€ Build players from room snapshot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playersFromRoom(room) {
  const players = Object.values(room.players||{});
  for (const p of players) {
    p.color  = (room.colors||{})[p.id]||null;
    const g  = (room.gostos||{})[p.id];
    p.gostos = g ? g.gostos : [];
    p.ready  = g ? g.ready  : false;
  }
  return players;
}

// â”€â”€ Main listener â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startListening() {
  if (S.unsubRoom) S.unsubRoom();
  S.unsubRoom = fbListen(pRoom(S.roomCode), room => {
    if (!room) return;
    const players = playersFromRoom(room);
    const cur = document.querySelector('.screen.active')?.id?.replace('screen-','');

    if (room.status==='lobby')       renderLobby(room, players);
    if (room.status==='color') {
      if (cur==='lobby')             { showScreen('color'); buildColorGrid(players); }
      if (cur==='color')               buildColorGrid(players);
      if (S.isHost) { const all=players.every(p=>p.color); if(all&&players.length>0) hostAdvanceTo(room,'gostos'); }
    }
    if (room.status==='gostos') {
      if (cur==='color'||cur==='lobby') buildGostosInputs(players);
      if (cur==='gostos')               renderReadyList(players);
      if (S.isHost) { const all=players.length>0&&players.every(p=>p.ready); if(all) hostBuildGame(room,players); }
    }
    if (room.status==='game') {
      if (cur==='gostos'||cur==='lobby'||cur==='vote-results') showGameScreen(room,players);
      if (cur==='game') {
        if (room.currentRound!==S.currentRoundIdx) showGameScreen(room,players);
        if (S.isHost) hostCheckVotes(room,players);
      }
    }
    if (room.status==='vote_result') {
      if (cur==='game') showVoteResult(room,players);
      if (cur==='vote-results') renderVoteResult(room,players);
    }
    if (room.status==='final') {
      if (cur!=='final') showFinalScreen(room,players);
    }
  });
}

// â”€â”€ Create Room â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function createRoom() {
  if (!db) { toast('âŒ Firebase nÃ£o conectado!'); return; }
  const name = document.getElementById('create-name').value.trim();
  if (!name) { toast('âš ï¸ Digite seu nome!'); playError(); return; }

  const btn = document.querySelector('#screen-create-room .btn-primary');
  if (btn) { btn.disabled=true; btn.textContent='â³ Criando...'; }

  S.myId=genId(); S.myName=name; S.isHost=true;

  let saved=false;
  for (let attempt=0; attempt<5; attempt++) {
    const code=genCode(); S.roomCode=code;
    const ok = await fbSet(pRoom(code), {
      code, host:S.myId, maxPlayers:S.maxPlayers,
      status:'lobby', currentRound:-1, rounds:[],
      roundStartTime:0, createdAt:Date.now(),
      players:{ [S.myId]:{ id:S.myId, name, score:0, streak:0 } },
      colors:{}, gostos:{}, votes:{},
    });
    if (ok) {
      await new Promise(r=>setTimeout(r,300));
      const verify = await fbGet(pRoom(code));
      if (verify&&verify.code===code) { saved=true; break; }
    }
    await new Promise(r=>setTimeout(r,400+attempt*200));
  }

  if (btn) { btn.disabled=false; btn.textContent='Criar Sala ğŸš€'; }
  if (!saved) { toast('âŒ Erro ao criar sala. Tente novamente.'); playError(); return; }

  playSuccess();
  startListening();
  showScreen('lobby');
  toast('ğŸ‰ Sala criada! Compartilhe o cÃ³digo.');
}
window.createRoom = createRoom;

// â”€â”€ Join Room â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function joinRoom() {
  if (!db) { toast('âŒ Firebase nÃ£o conectado!'); return; }
  const code = document.getElementById('join-code').value.trim().toUpperCase();
  const name = document.getElementById('join-name').value.trim();
  if (!code) { toast('âš ï¸ Digite o cÃ³digo!'); playError(); return; }
  if (!name) { toast('âš ï¸ Digite seu nome!');  playError(); return; }

  const btn = document.getElementById('join-btn');
  if (btn) { btn.disabled=true; btn.textContent='ğŸ” Buscando...'; }
  toast('ğŸ” Verificando sala...', 8000);

  const room = await fbGet(pRoom(code));
  if (btn) { btn.disabled=false; btn.textContent='Entrar ğŸ®'; }

  if (!room)                    { toast('âŒ Sala nÃ£o encontrada!');    playError(); return; }
  if (room.status!=='lobby')    { toast('âŒ O jogo jÃ¡ comeÃ§ou!');      playError(); return; }
  const cnt = Object.keys(room.players||{}).length;
  if (cnt>=room.maxPlayers)     { toast('âŒ Sala cheia!');             playError(); return; }

  S.myId=genId(); S.myName=name; S.isHost=false; S.roomCode=code;

  const ok = await fbUpdate(pRoom(code), {
    [`players/${S.myId}`]: { id:S.myId, name, score:0, streak:0 }
  });
  if (!ok) { toast('âŒ Erro ao entrar. Tente novamente.'); playError(); return; }

  playSuccess();
  startListening();
  showScreen('lobby');
}
window.joinRoom = joinRoom;

// â”€â”€ Host helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function hostAdvanceTo(room, status) {
  if (room.status===status) return;
  await fbUpdate(pRoom(S.roomCode), { status });
}

async function hostBuildGame(room, players) {
  if (room.status!=='gostos') return;
  let all=[];
  for (const p of players) (p.gostos||[]).forEach(g => all.push({ownerId:p.id, text:g}));
  for (let i=all.length-1;i>0;i--) { const j=Math.floor(Math.random()*(i+1)); [all[i],all[j]]=[all[j],all[i]]; }
  S.totalRounds = all.length;
  await fbUpdate(pRoom(S.roomCode), {
    rounds: all.map(g=>({ownerId:g.ownerId, gosto:g.text})),
    currentRound:0, roundStartTime:Date.now(), status:'game', totalRounds:all.length,
  });
}

async function hostCheckVotes(room, players) {
  const roundIdx = room.currentRound;
  const votes    = (room.votes||{})[roundIdx]||{};
  if (Object.keys(votes).length < players.length) return;

  const rounds  = Array.isArray(room.rounds)?room.rounds:Object.values(room.rounds||{});
  const round   = rounds[roundIdx]; if (!round) return;
  const correct = round.ownerId;
  const updates = {};

  for (const [voterId, voted] of Object.entries(votes)) {
    if (voted===correct && voterId!==correct) {
      const p = players.find(x=>x.id===voterId);
      if (p) {
        const newStreak = (p.streak||0)+1;
        const bonus = newStreak>=3 ? 150 : 100; // streak bonus
        updates[`players/${voterId}/score`]  = (p.score||0)+bonus;
        updates[`players/${voterId}/streak`] = newStreak;
      }
    } else if (voted!==correct) {
      const p = players.find(x=>x.id===voterId);
      if (p) updates[`players/${voterId}/streak`] = 0; // reset streak on miss
    }
  }

  updates[`rounds/${roundIdx}/votes`] = votes;
  updates['status'] = 'vote_result';
  await fbUpdate(pRoom(S.roomCode), updates);
}

// â”€â”€ Lobby â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLobby(room, players) {
  document.getElementById('lobby-code').textContent = room.code;
  document.getElementById('lobby-count').textContent = players.length;
  document.getElementById('lobby-max').textContent   = room.maxPlayers;

  document.getElementById('lobby-players').innerHTML = players.map(p => {
    const isHost = p.id===room.host;
    const col    = p.color ? colorHex(p.color) : '#444';
    return `<div class="player-item">
      <div class="player-dot" style="background:${col};box-shadow:0 0 12px ${col}"></div>
      <div class="player-name">${p.name}${isHost?'<span class="host-badge">HOST</span>':''}</div>
    </div>`;
  }).join('');

  const meHost = S.myId===room.host;
  document.getElementById('lobby-start-wrap').style.display = meHost&&players.length>=2 ? 'block':'none';
  document.getElementById('lobby-wait-msg').style.display   = meHost ? 'none':'block';
}

async function startGame() {
  const room = await fbGet(pRoom(S.roomCode)); if (!room) return;
  playSuccess();
  await hostAdvanceTo(room,'color');
  showScreen('color');
}
window.startGame = startGame;

// â”€â”€ Color Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildColorGrid(players) {
  const taken = players.filter(p=>p.color&&p.id!==S.myId).map(p=>p.color);
  document.getElementById('colors-grid').innerHTML = COLORS.map(c => {
    const isTaken = taken.includes(c.id);
    const isSel   = S.selectedColor===c.id;
    return `<button class="color-btn ${isTaken?'taken':''} ${isSel?'selected':''}"
      style="background:${c.hex};box-shadow:0 4px 16px ${c.hex}55;"
      title="${c.name}" onclick="selectColor('${c.id}',${isTaken})"
      data-color="${c.id}"></button>`;
  }).join('');
  document.getElementById('confirm-color-btn').disabled = !S.selectedColor;
}

function selectColor(colorId, taken) {
  if (taken) { toast('âš ï¸ Cor jÃ¡ escolhida!'); playError(); return; }
  S.selectedColor = colorId;
  playTone(550);
  document.querySelectorAll('.color-btn').forEach(b=>b.classList.toggle('selected', b.dataset.color===colorId));
  document.getElementById('confirm-color-btn').disabled = false;
}
window.selectColor = selectColor;

async function confirmColor() {
  if (!S.selectedColor) return;
  S.myColor = S.selectedColor;
  await fbUpdate(pRoom(S.roomCode), { [`colors/${S.myId}`]: S.selectedColor });
  playSuccess(); toast(`ğŸ¨ Cor ${colorName(S.selectedColor)} confirmada!`);
  document.getElementById('confirm-color-btn').disabled = true;
}
window.confirmColor = confirmColor;

// â”€â”€ Gostos Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildGostosInputs(players) {
  const hex  = S.myColor ? colorHex(S.myColor) : '#888';
  const wrap = document.getElementById('gostos-inputs');
  if (!wrap.querySelector('#gosto-0')) {
    wrap.innerHTML = Array.from({length:5},(_,i)=>`
      <div class="gosto-row">
        <div class="gosto-num" style="background:${hex};box-shadow:0 0 10px ${hex}88">${i+1}</div>
        <input type="text" placeholder="Gosto ${i+1}..." maxlength="80" id="gosto-${i}"
          oninput="autoSaveGosto(${i})" style="transition:all 0.2s;">
      </div>`).join('');
  }
  showScreen('gostos');
  renderReadyList(players);
}

// auto-save draft indicator
let autoSaveTimer;
function autoSaveGosto() {
  clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(()=>{
    const filled = Array.from({length:5},(_,i)=>document.getElementById(`gosto-${i}`)?.value.trim()||'').filter(Boolean).length;
    document.getElementById('confirm-gostos-btn').textContent = filled===5 ? 'âœ… Confirmar Gostos' : `âœ… Confirmar Gostos (${filled}/5)`;
  },300);
}
window.autoSaveGosto = autoSaveGosto;

function renderReadyList(players) {
  const ready = players.filter(p=>p.ready);
  document.getElementById('ready-count').textContent = `${ready.length}/${players.length}`;
  document.getElementById('ready-players').innerHTML = players.map(p=>`
    <div class="player-item">
      <div class="player-dot" style="background:${p.color?colorHex(p.color):'#444'};box-shadow:0 0 10px ${p.color?colorHex(p.color):'#444'}44"></div>
      <div class="player-ready" style="margin-left:0;">${p.ready
        ?'<span class="chip chip-green">âœ… Pronto</span>'
        :'<span class="chip" style="background:rgba(255,255,255,0.05);color:var(--text-muted);">âœï¸ Escrevendo...</span>'}</div>
    </div>`).join('');
}

async function confirmGostos() {
  const gostos = Array.from({length:5},(_,i)=>document.getElementById(`gosto-${i}`)?.value.trim()||'');
  if (gostos.some(g=>!g)) { toast('âš ï¸ Preencha todos os 5 gostos!'); playError(); return; }
  S.myGostos=gostos;
  await fbUpdate(pRoom(S.roomCode), { [`gostos/${S.myId}`]:{ gostos, ready:true } });
  playSuccess(); toast('âœ… Gostos salvos! Aguardando todos...');
  document.getElementById('confirm-gostos-btn').disabled = true;
}
window.confirmGostos = confirmGostos;

// â”€â”€ Game Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showGameScreen(room, players) {
  S.currentRoundIdx = room.currentRound;
  S.hasVoted = false;

  const rounds = Array.isArray(room.rounds)?room.rounds:Object.values(room.rounds||{});
  const round  = rounds[room.currentRound]; if (!round) return;
  const total  = room.totalRounds || rounds.length;

  document.getElementById('round-counter').textContent = `GOSTO ${room.currentRound+1} / ${total}`;
  document.getElementById('gosto-text').textContent    = round.gosto;
  document.getElementById('voted-msg').style.display   = 'none';

  // Progress bar
  const pct = Math.round((room.currentRound/total)*100);
  document.getElementById('progress-fill').style.width = pct+'%';
  document.getElementById('progress-label-text').textContent = `${room.currentRound} / ${total} gostos`;

  const myPlayer = players.find(p=>p.id===S.myId);
  document.getElementById('my-score').textContent = myPlayer?.score||0;

  buildVoteGrid(players, round);
  startTimer(room, total);
  showScreen('game');
}

function buildVoteGrid(players, round) {
  const shuffled = [...players].sort(()=>Math.random()-0.5);
  document.getElementById('vote-grid').innerHTML = shuffled.map(p => {
    const hex = p.color?colorHex(p.color):'#888';
    return `<button class="vote-btn" id="vote-btn-${p.id}" onclick="castVote('${p.id}')">
      <div class="vote-color" style="background:${hex};box-shadow:0 0 10px ${hex}88;"></div>
      <span>${p.name}</span>
    </button>`;
  }).join('');
}

function startTimer(room, totalRounds) {
  clearInterval(S.timerInterval);
  const total   = VOTE_TIME*1000;
  const startTs = room.roundStartTime||Date.now();
  const circ    = CIRCUMFERENCE;
  const circle  = document.getElementById('countdown-circle');
  const timerEl = document.getElementById('timer-text');
  const wrap    = document.getElementById('screen-game');

  function tick() {
    const rem = Math.max(0, total-(Date.now()-startTs));
    const pct = rem/total;
    const sec = Math.ceil(rem/1000);

    if (circle) circle.style.strokeDashoffset = circ*(1-pct);
    if (timerEl) timerEl.textContent = sec;

    // Urgent state when under 5s
    const urgent = sec<=5;
    wrap.classList.toggle('timer-urgent', urgent);
    if (urgent && sec>0) playTick();

    if (rem<=0) { clearInterval(S.timerInterval); if (!S.hasVoted) autoVote(); }
  }
  tick();
  S.timerInterval = setInterval(tick, 200);
}

async function autoVote() {
  if (S.hasVoted) return;
  const room    = await fbGet(pRoom(S.roomCode));
  const players = playersFromRoom(room);
  const rand    = players[Math.floor(Math.random()*players.length)];
  if (rand) castVote(rand.id, true);
}

async function castVote(targetId, auto=false) {
  if (S.hasVoted) return;
  S.hasVoted = true;
  clearInterval(S.timerInterval);
  if (!auto) {
    playVote();
    document.querySelectorAll('.vote-btn').forEach(b=>b.classList.add('disabled-vote'));
    document.getElementById('vote-btn-'+targetId)?.classList.add('voted');
    document.getElementById('voted-msg').style.display = 'block';
  }
  await fbUpdate(pRoom(S.roomCode), { [`votes/${S.currentRoundIdx}/${S.myId}`]: targetId });
}
window.castVote = castVote;

// â”€â”€ Vote Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showVoteResult(room, players) {
  clearInterval(S.timerInterval);
  renderVoteResult(room, players);
  showScreen('vote-results');
}

function renderVoteResult(room, players) {
  const rounds = Array.isArray(room.rounds)?room.rounds:Object.values(room.rounds||{});
  const round  = rounds[room.currentRound]; if (!round) return;
  const owner    = players.find(p=>p.id===round.ownerId);
  const ownerHex = owner?.color?colorHex(owner.color):'#888';

  document.getElementById('result-gosto-text').textContent = round.gosto;
  document.getElementById('result-gosto-color').style.cssText = `width:32px;height:32px;border-radius:50%;background:${ownerHex};border:2px solid rgba(255,255,255,0.3);box-shadow:0 0 20px ${ownerHex};`;
  document.getElementById('result-owner-name').textContent = owner?.name||'?';

  const votes      = round.votes||{};
  const totalVotes = Object.values(votes).length;
  const counts     = {};
  players.forEach(p=>counts[p.id]=0);
  Object.values(votes).forEach(v=>{ if(counts[v]!==undefined) counts[v]++; });

  // Did I vote correctly?
  const myVote = votes[S.myId];
  const iCorrect = myVote===round.ownerId && S.myId!==round.ownerId;
  const comboBanner = document.getElementById('combo-banner');
  if (iCorrect) {
    S.combo++;
    comboBanner.style.display = 'block';
    const bonus = S.combo>=3 ? 150:100;
    document.getElementById('combo-text').textContent = S.combo>=3 ? `ğŸ”¥ +${bonus} (streak x${S.combo}!)` : `âœ… +${bonus} pontos!`;
    document.getElementById('combo-sub').textContent  = S.combo>=3 ? 'IncrÃ­vel! SequÃªncia de acertos!' : 'VocÃª acertou!';
    playSuccess();
    if (S.combo>=3) launchConfetti(40);
  } else {
    S.combo = 0;
    comboBanner.style.display = 'none';
  }

  // Build bars with animation delay
  const sorted = [...players].sort((a,b)=>(counts[b.id]||0)-(counts[a.id]||0));
  document.getElementById('result-bars').innerHTML = sorted.map((p,i) => {
    const cnt = counts[p.id]||0;
    const pct = totalVotes>0 ? Math.round(cnt/totalVotes*100):0;
    const isOwner = p.id===round.ownerId;
    const hex = p.color?colorHex(p.color):'#888';
    const myVoted = myVote===p.id;
    return `<div class="result-row" style="animation:fadeIn 0.3s ease ${i*0.1}s both;">
      <div style="width:30px;height:30px;border-radius:50%;background:${hex};flex-shrink:0;
        border:2px solid ${isOwner?'white':'rgba(255,255,255,0.1)'};
        box-shadow:0 0 ${isOwner?'15px '+hex:'none'};"></div>
      <div class="result-bar-bg" style="flex:1;">
        <div class="result-bar-fill" style="width:${pct}%;background:${hex};
          box-shadow:${pct>0?'0 0 10px '+hex+'66':'none'}">
          ${pct>15?'<span style="color:rgba(0,0,0,0.8);font-size:0.8rem;">'+p.name+'</span>':''}
        </div>
        <span class="result-pct">${pct}%</span>
      </div>
      ${isOwner?'<span class="owner-crown">ğŸ‘‘</span>':''}
      ${myVoted&&!isOwner?'<span style="font-size:0.8rem;">ğŸ‘ˆ</span>':''}
    </div>`;
  }).join('');

  const meHost = S.myId===room.host;
  document.getElementById('next-btn-wrap').style.display    = meHost?'block':'none';
  document.getElementById('next-wait-msg').style.display    = meHost?'none':'block';
}

async function nextRound() {
  const room   = await fbGet(pRoom(S.roomCode)); if (!room) return;
  const rounds = Array.isArray(room.rounds)?room.rounds:Object.values(room.rounds||{});
  const next   = room.currentRound+1;
  if (next>=rounds.length) {
    await fbUpdate(pRoom(S.roomCode), { status:'final' });
  } else {
    await fbUpdate(pRoom(S.roomCode), { currentRound:next, roundStartTime:Date.now(), status:'game' });
  }
}
window.nextRound = nextRound;

// â”€â”€ Final Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showFinalScreen(room, players) {
  clearInterval(S.timerInterval);
  launchConfetti(120);
  playSuccess();

  const sorted = [...players].sort((a,b)=>(b.score||0)-(a.score||0));
  const winner = sorted[0];

  document.getElementById('winner-name').textContent = winner.name;
  document.getElementById('winner-pts').textContent  = `${winner.score||0} pontos`;

  // Stats
  const rounds = Array.isArray(room.rounds)?room.rounds:Object.values(room.rounds||{});
  const myVotesCorrect = rounds.filter(r=>{
    const v=(r.votes||{})[S.myId]; return v===r.ownerId&&S.myId!==r.ownerId;
  }).length;
  document.getElementById('final-stat-grid').innerHTML = `
    <div class="stat-box"><div class="stat-val">${rounds.length}</div><div class="stat-label">Gostos</div></div>
    <div class="stat-box"><div class="stat-val">${myVotesCorrect}</div><div class="stat-label">Meus acertos</div></div>
    <div class="stat-box"><div class="stat-val">${players.length}</div><div class="stat-label">Jogadores</div></div>`;

  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  document.getElementById('final-scores').innerHTML = sorted.map((p,i)=>`
    <div class="score-row" style="animation:fadeIn 0.3s ease ${i*0.1}s both;${i===0?'border-color:rgba(245,166,35,0.3);background:rgba(245,166,35,0.05);':''}">
      <div class="score-pos">${medals[i]||(i+1)+'Â°'}</div>
      <div class="player-dot" style="background:${p.color?colorHex(p.color):'#888'};width:26px;height:26px;flex-shrink:0;"></div>
      <div class="player-name">${p.name}</div>
      <div class="score-pts">${p.score||0} pts</div>
    </div>`).join('');

  // Tables
  const wrap = document.getElementById('final-tables-wrap');
  wrap.innerHTML = `<div style="font-family:'Fredoka One',cursive;font-size:1.2rem;color:var(--accent);margin:6px 0 14px;width:100%;display:flex;align-items:center;gap:8px;">ğŸ“‹ Gostos Revelados</div>`;
  sorted.forEach(p => {
    const hex    = p.color?colorHex(p.color):'#888';
    const pRnd   = rounds.filter(r=>r.ownerId===p.id);
    const div    = document.createElement('div');
    div.className='table-wrap';
    const accuracy = pRnd.length>0 ? Math.round(pRnd.reduce((acc,r)=>{
      const votes=r.votes||{}; const hits=Object.entries(votes).filter(([vid,v])=>v===p.id&&vid!==p.id).length;
      const total=Object.keys(votes).filter(vid=>vid!==p.id).length;
      return acc+(total>0?hits/total:0);
    },0)/pRnd.length*100) : 0;
    div.innerHTML=`
      <div class="table-header">
        <div class="table-header-color" style="background:${hex};box-shadow:0 0 12px ${hex}"></div>
        <div class="table-header-name">${p.name}</div>
        <span class="chip chip-gold" style="margin-left:auto;">${accuracy}% reconhecido</span>
      </div>
      <table class="final-table">
        <thead><tr><th>Gosto</th><th>Acertaram</th><th>Erraram</th></tr></thead>
        <tbody>${pRnd.map(r=>{
          const votes=r.votes||{};
          const hits  =Object.entries(votes).filter(([vid,v])=>v===p.id&&vid!==p.id);
          const misses=Object.entries(votes).filter(([vid,v])=>v!==p.id&&vid!==p.id);
          const nm=id=>sorted.find(x=>x.id===id)?.name||'?';
          return `<tr><td>${r.gosto}</td>
            <td>${hits.length?`<span class="chip chip-green">âœ… ${hits.map(([v])=>nm(v)).join(', ')}</span>`:'<span class="chip" style="background:rgba(255,255,255,0.04);color:var(--text-muted)">â€”</span>'}</td>
            <td>${misses.length?`<span class="chip chip-red">âŒ ${misses.map(([v])=>nm(v)).join(', ')}</span>`:'<span class="chip" style="background:rgba(255,255,255,0.04);color:var(--text-muted)">â€”</span>'}</td>
          </tr>`;
        }).join('')}</tbody>
      </table>`;
    wrap.appendChild(div);
  });

  showScreen('final');
}

async function resetGame() {
  clearInterval(S.timerInterval);
  if (S.unsubRoom) { S.unsubRoom(); S.unsubRoom=null; }
  Object.assign(S,{
    myId:null,myName:null,myColor:null,myGostos:[],
    roomCode:null,isHost:false,maxPlayers:6,selectedColor:null,
    hasVoted:false,currentRoundIdx:-1,combo:0,totalRounds:0,
  });
  showScreen('home');
}
window.resetGame = resetGame;

// â”€â”€ Input helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('join-code')?.addEventListener('input', function(){ this.value=this.value.toUpperCase(); });
document.getElementById('create-name')?.addEventListener('keydown', e=>{ if(e.key==='Enter') createRoom(); });
document.getElementById('join-name')?.addEventListener('keydown',   e=>{ if(e.key==='Enter') joinRoom(); });
</script>
</body>
</html>
